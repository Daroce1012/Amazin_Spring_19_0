# Documentaci√≥n de Implementaci√≥n - AmazinSpring
**MIW - Arquitectura de Sitios Web - Trabajo 2**

---

## √çndice
1. [Introducci√≥n](#introducci√≥n)
2. [Acceso a la Aplicaci√≥n](#acceso-a-la-aplicaci√≥n)
3. [Requisito 1: Compra de Libros](#requisito-1-compra-de-libros)
4. [Requisito 2: Sistema de Reservas](#requisito-2-sistema-de-reservas)
5. [Requisito 3: Internacionalizaci√≥n](#requisito-3-internacionalizaci√≥n)
6. [Arquitectura General](#arquitectura-general)
7. [Conclusiones](#conclusiones)

---

## Introducci√≥n

Este documento describe la implementaci√≥n completa de las funcionalidades requeridas 
para el Trabajo 2 de la asignatura Arquitectura de Sitios Web del M√°ster en Ingenier√≠a 
Web. La implementaci√≥n se ha realizado respetando la arquitectura en capas del piloto 
original (Presentaci√≥n ‚Üí Negocio ‚Üí Persistencia) y manteniendo los convenios de nombres 
establecidos.

---

## Acceso a la Aplicaci√≥n

### URL de Acceso

La aplicaci√≥n est√° desplegada en una m√°quina virtual y es accesible a trav√©s de la siguiente URL:

**üîó http://156.35.95.57:8080/Amazin_Spring_19_0/**

### Informaci√≥n de Despliegue

- **Servidor**: Apache Tomcat
- **Puerto**: 8080
- **Contexto**: /Amazin_Spring_19_0
- **Base de Datos**: HSQLDB (hsql://localhost/amazin19)

---

## Requisito 1: Compra de Libros

### 1.1 Control de Stock en Base de Datos

#### Modelo de Datos
Se ha modificado la entidad `Book` para incluir un atributo de stock:

```java
@Entity
public class Book {
    @Id @GeneratedValue
    private int id;
    private String title;
    private String description;
    private String author;
    private double basePrice;
    private int stock;  // ‚Üê NUEVO ATRIBUTO
    // ...
}
```

**Persistencia:** El atributo `stock` se mapea autom√°ticamente a la base de datos 
mediante JPA. La configuraci√≥n de JPA est√° en `persistence.xml`:

```xml
<property name="jakarta.persistence.schema-generation.database.action" 
          value="update" />
```

Esta propiedad permite que Hibernate actualice el esquema de la base de datos 
autom√°ticamente al detectar el nuevo campo.

**Inicializaci√≥n:** Seg√∫n el requisito, cada libro debe tener 10 unidades disponibles 
al despliegue. Esto se gestiona a trav√©s de scripts de inicializaci√≥n de base de datos 
o mediante la inserci√≥n manual de los datos con valores de stock = 10.

---

### 1.2 Carrito de la Compra

#### Modelo del Carrito
Se han creado dos clases principales para gestionar el carrito:

**Cart.java** - Contenedor principal del carrito:
```java
public class Cart implements Serializable {
    private List<CartItem> items;
    
    // A√±ade un item al carrito, incrementa cantidad 
    // si ya existe
    public void addItem(Book book, int quantity, 
                       boolean isReserved);
    
    // Busca un item por ID de libro y tipo (reserva o compra)
    public CartItem findItemByBookId(int bookId, 
                                     boolean isReserved);
    
    // Elimina un item espec√≠fico
    public void removeItem(int bookId, boolean isReserved);
    
    // Calcula el total del carrito
    public double getTotal();
    
    // Vac√≠a el carrito
    public void clear();
}
```

**CartItem.java** - Representa un item individual en el carrito:
```java
public class CartItem implements Serializable {
    private Book book;
    private int quantity;
    private boolean isReserved;  // Reserva o compra normal
    
    // Calcula el subtotal considerando si es reserva 
    // (95%) o compra (100%)
    public double getSubtotal() {
        if (isReserved) {
            // 95% restante a pagar
            return book.getPrice() * quantity * 0.95;
        }
        return book.getPrice() * quantity;
    }
}
```

#### Capa de Presentaci√≥n

**CartController.java** - Gestiona las peticiones HTTP relacionadas con el carrito:

- **`addToCart`**: A√±ade un libro al carrito
  - Valida stock disponible antes de a√±adir
  - Utiliza la sesi√≥n HTTP para almacenar el carrito
  - Redirige al cat√°logo con mensaje de √©xito/error

- **`viewCart`**: Muestra el contenido del carrito
  - Sincroniza las reservas desde la base de datos
  - Calcula el total incluyendo reservas pendientes

- **`removeFromCart`**: Elimina un item del carrito
  - Distingue entre items normales y reservas
  - Si es reserva, cancela en BD y restaura stock

- **`clearCart`**: Vac√≠a todo el carrito
  - Cancela todas las reservas asociadas
  - Restaura el stock de los libros reservados

- **`checkout`**: Procesa la compra completa
  - Valida stock en tiempo real
  - Reduce stock en BD para compras normales
  - Procesa las reservas (elimina de BD sin restaurar stock)

#### Capa de Negocio

**CartManager.java** - Implementa la l√≥gica de negocio del carrito:

```java
@Override
public void addBookToCart(Cart cart, int bookId, int quantity) 
        throws Exception {
    // 1. Obtener el libro con precio calculado
    Book book = bookManagerService.getBookById(bookId);
    
    // 2. Calcular cantidad total solicitada
    int totalRequested = quantity;
    CartItem existingItem = 
        cart.findItemByBookId(bookId, false);
    if (existingItem != null) {
        totalRequested += existingItem.getQuantity();
    }
    
    // 3. Verificar stock disponible
    if (!bookManagerService.checkStockAvailability(
            bookId, totalRequested)) {
        throw new Exception("cart.notEnoughStock");
    }
    
    // 4. A√±adir al carrito (no reduce stock hasta checkout)
    cart.addItem(book, quantity, false);
}
```

**Sincronizaci√≥n con Reservas:**
```java
@Override
public void synchronizeCartForUser(String username, Cart cart) 
        throws Exception {
    // Obtener reservas del usuario desde BD
    List<Reservation> reservations = 
        reservationManagerService.getReservations(username);
    
    // Eliminar todas las reservas del carrito
    cart.removeAllItems(true);
    
    // Agregar todas las reservas desde BD 
    // (la BD es la fuente de verdad)
    for (Reservation res : reservations) {
        cart.addItem(res.getBook(), 
                    res.getQuantity(), true);
    }
}
```

**Proceso de Checkout:**
```java
@Override
public boolean checkout(String username, Cart cart) 
        throws Exception {
    // 1. Procesar reservas (eliminar de BD sin restaurar stock)
    reservationManagerService
        .processReservationsInCart(username, cart);
    
    // 2. Procesar compras normales
    for (CartItem item : cart.getItems()) {
        if (!item.isReserved()) {
            // Reducir stock con validaci√≥n en tiempo real
            boolean reduced = bookManagerService
                .reduceStock(item.getBookId(), 
                           item.getQuantity());
            if (!reduced) {
                return false; // Stock insuficiente
            }
        }
    }
    
    return true;
}
```

---

### 1.3 Validaci√≥n de Disponibilidad

#### Capa de Negocio
**BookManager.java** expone m√©todos para verificar y modificar stock:

```java
@Override
public boolean checkStockAvailability(int bookId, 
                                     int requestedQuantity) 
        throws Exception {
    return bookDataService
        .checkStockAvailability(bookId, requestedQuantity);
}

@Override
public boolean reduceStock(int bookId, int quantity) 
        throws Exception {
    return bookDataService.reduceStock(bookId, quantity);
}

@Override
public boolean increaseStock(int bookId, int quantity) 
        throws Exception {
    bookDataService.increaseBookStock(bookId, quantity);
    return true;
}
```

#### Capa de Persistencia
**BookDAO.java** - Implementa las operaciones at√≥micas de stock:

**Verificaci√≥n de Stock:**
```java
@Override
public boolean checkStockAvailability(int bookId, int requestedQuantity) 
        throws Exception {
    Dba dba = new Dba(true); // Solo lectura
    try {
        EntityManager em = dba.getActiveEm();
        Book book = em.find(Book.class, bookId);
        
        if (book != null) {
            boolean available = 
                book.getStock() >= requestedQuantity;
            logger.debug("Stock check: Requested={}, " +
                        "Available={}", requestedQuantity, 
                        book.getStock());
            return available;
        }
        return false;
    } finally {
        dba.closeEm();
    }
}
```

**Reducci√≥n de Stock (con bloqueo pesimista):**
```java
@Override
public boolean reduceStock(int bookId, int quantity) 
        throws Exception {
    Dba dba = new Dba();
    try {
        EntityManager em = dba.getActiveEm();
        
        // BLOQUEO PESIMISTA para evitar condiciones de carrera
        Book book = em.find(Book.class, bookId, 
                           LockModeType.PESSIMISTIC_WRITE);
        
        if (book != null && book.getStock() >= quantity) {
            book.setStock(book.getStock() - quantity);
            em.merge(book);
            return true;
        }
        return false;
    } finally {
        dba.closeEm();
    }
}
```

**Incremento de Stock (restauraci√≥n):**
```java
@Override
public void increaseBookStock(int bookId, int quantity) 
        throws Exception {
    Dba dba = new Dba();
    try {
        EntityManager em = dba.getActiveEm();
        
        // Bloqueo pesimista para operaci√≥n at√≥mica
        Book book = em.find(Book.class, bookId, 
                           LockModeType.PESSIMISTIC_WRITE);
        
        if (book != null) {
            int newStock = book.getStock() + quantity;
            book.setStock(newStock);
            em.merge(book);
            logger.debug("Stock increased: New stock=" 
                        + newStock);
        }
    } finally {
        dba.closeEm();
    }
}
```


---

### 1.4 Actualizaci√≥n de Stock tras Checkout

La actualizaci√≥n del stock se realiza en dos momentos:

1. **Durante la reserva**: El stock se reduce inmediatamente al crear/actualizar una reserva
2. **Durante el checkout**: El stock se reduce para las compras normales

**Proceso de Checkout completo:**
```java
@Override
public boolean checkout(String username, Cart cart) 
        throws Exception {
    // Procesar reservas (ya redujeron stock al crearse)
    reservationManagerService
        .processReservationsInCart(username, cart);
    
    // Procesar compras normales (reducir stock ahora)
    for (CartItem item : cart.getItems()) {
        if (!item.isReserved()) {
            boolean reduced = bookManagerService
                .reduceStock(item.getBookId(), 
                           item.getQuantity());
            if (!reduced) {
                return false;
            }
        }
    }
    return true;
}
```

---

## Requisito 2: Sistema de Reservas

### 2.1 Modelo de Reservas

#### Entidad Reservation
Se ha creado una nueva entidad JPA para gestionar las reservas:

```java
@Entity
public class Reservation {
    @Id @GeneratedValue
    private int id;
    
    @ManyToOne(fetch = FetchType.EAGER)
    @JoinColumn(name = "book_id", nullable = false)
    private Book book;
    
    private String username;
    private int quantity;
    
    // Calcula el 5% pagado en la reserva
    public double getReservationPrice() {
        return book.getPrice() * quantity * 0.05;
    }
    
    // Calcula el 95% restante por pagar
    public double getRemainingAmount() {
        return book.getPrice() * quantity * 0.95;
    }
}
```

**Relaci√≥n con Book:** Se establece una relaci√≥n `@ManyToOne` con carga eager para 
que siempre se cargue el libro junto con la reserva, evitando problemas de lazy loading.

---

### 2.2 Funcionalidad de Reserva

#### Capa de Presentaci√≥n

**ReservationController.java** - Gestiona las peticiones de reservas:

```java
@RequestMapping("private/reserveBook")
public String reserveBook(
        @RequestParam("bookId") int bookId, 
        @RequestParam("quantity") int quantity,
        Principal principal, HttpSession session) {
    
    synchronized (servletContext) {
        try {
            String username = principal.getName();
            
            // Toda la l√≥gica encapsulada en el servicio
            reservationManagerService
                .reserveBook(username, bookId, quantity);
            
            session.setAttribute("message", 
                               "reservation.created");
            return "redirect:showBooks";
            
        } catch (Exception e) {
            handleReservationError(e, session, null, 
                                  "Error reserving book", true);
            return "redirect:showBooks";
        }
    }
}
```

#### Capa de Negocio

**ReservationManager.java** - L√≥gica de negocio de reservas:

```java
@Override
public Reservation reserveBook(String username, int bookId, 
                              int quantity) throws Exception {
    // 1. Verificar si ya existe una reserva del 
    // usuario para este libro
    Reservation existingReservation = 
        getReservationByUserAndBook(username, bookId);
    boolean isNewReservation = 
        (existingReservation == null);
    
    // 2. Si es nueva, validar que el libro existe
    if (isNewReservation) {
        Book book = bookManagerService.getBookById(bookId);
        if (book == null) {
            throw new Exception("reservation.bookNotFound");
        }
    }
    
    // 3. Verificar y reducir stock 
    // (IMPORTANTE: reduce inmediatamente)
    if (!bookManagerService
            .checkStockAvailability(bookId, quantity)) {
        throw new Exception("reservation.notEnoughStock");
    }
    
    boolean stockReduced = bookManagerService
        .reduceStock(bookId, quantity);
    if (!stockReduced) {
        throw new Exception("reservation.stockReductionFailed");
    }
    
    try {
        Reservation reservation;
        
        if (isNewReservation) {
            // Crear nueva reserva
            reservation = reservationDataService
                .createReservation(username, bookId, quantity);
        } else {
            // Actualizar reserva existente 
            // (incrementar cantidad)
            int newQuantity = 
                existingReservation.getQuantity() + quantity;
            existingReservation.setQuantity(newQuantity);
            reservation = reservationDataService
                .updateReservation(existingReservation);
        }
        
        return reservation;
        
    } catch (Exception e) {
        // Rollback: restaurar stock si falla 
        // la creaci√≥n/actualizaci√≥n
        bookManagerService.increaseStock(bookId, quantity);
        throw e;
    }
}
```

**Caracter√≠sticas importantes:**
- **Reducci√≥n inmediata de stock**: Al crear una reserva, el stock se reduce 
  inmediatamente para que no est√© disponible para otros usuarios
- **Reservas acumulativas**: Si un usuario reserva el mismo libro varias veces, 
  se incrementa la cantidad en lugar de crear m√∫ltiples reservas
- **Rollback autom√°tico**: Si falla la creaci√≥n de la reserva en BD, se restaura 
  el stock autom√°ticamente

---

### 2.3 Integraci√≥n con el Carrito

#### Marca Especial en el Carrito
Los items reservados se distinguen en el carrito mediante el atributo `isReserved`:

```java
public class CartItem {
    private boolean isReserved;
    
    // El subtotal se calcula seg√∫n el tipo
    public double getSubtotal() {
        if (isReserved) {
            // 95% pendiente
            return book.getPrice() * quantity * 0.95;
        }
        // 100% precio completo
        return book.getPrice() * quantity;
    }
}
```

#### Vista del Carrito (viewCart.jsp)
```jsp
<td>
    <c:choose>
        <c:when test="${item.reserved}">
            <span style="color: orange; font-weight: bold;">
                <spring:message code="cart.reservation"/> 
                (95% <spring:message code="cart.pending"/>)
            </span>
        </c:when>
        <c:otherwise>
            <spring:message code="cart.purchase"/>
        </c:otherwise>
    </c:choose>
</td>
```

#### Sincronizaci√≥n Autom√°tica
Cada vez que un usuario accede a `viewCart`, el sistema sincroniza autom√°ticamente 
las reservas desde la base de datos:

```java
@RequestMapping("private/viewCart")
public String viewCart(Principal principal, 
                      HttpSession session, 
                      Model model) {
    String username = principal.getName();
    Cart cart = getOrCreateCart(session);
    
    // Sincronizar con reservas (la BD es la fuente de verdad)
    cartManagerService.synchronizeCartForUser(username, cart);
    
    session.setAttribute(CART_ATTRIBUTE, cart);
    model.addAttribute("total", cart.getTotal());
    return "private/viewCart";
}
```

---

### 2.4 Reducci√≥n de Stock en Reservas

**Momento de reducci√≥n:** El stock se reduce **inmediatamente** al crear o 
incrementar una reserva, no al finalizar la compra. Esto garantiza que los libros 
reservados no est√©n disponibles para otros usuarios.

**Implementaci√≥n en ReservationManager:**
```java
// Verificar y reducir stock (com√∫n para ambos casos)
if (!bookManagerService.checkStockAvailability(bookId, quantity)) {
    throw new Exception("reservation.notEnoughStock");
}

boolean stockReduced = bookManagerService.reduceStock(bookId, quantity);
if (!stockReduced) {
    throw new Exception("reservation.stockReductionFailed");
}
```

**Consecuencias:**
- Los libros reservados se muestran con stock reducido en el cat√°logo
- Otros usuarios no pueden comprar ni reservar libros que ya est√°n reservados
- Si se cancela una reserva, el stock se restaura inmediatamente

---

### 2.5 Secci√≥n "Mis Reservas"

#### Controlador
```java
@RequestMapping("private/myReservations")
public String myReservations(Principal principal, Model model) {
    try {
        String username = principal.getName();
        List<Reservation> reservations = 
            reservationManagerService.getReservations(username);
        
        model.addAttribute("reservations", reservations);
        return "private/myReservations";
        
    } catch (Exception e) {
        logger.error("Error getting reservations", e);
        model.addAttribute("error", "error.general");
        return "private/error";
    }
}
```

#### Vista (myReservations.jsp)
La vista muestra una tabla con:
- T√≠tulo del libro
- Autor
- Precio unitario
- Cantidad reservada
- Importe pagado (5%)
- Importe pendiente (95%)
- Botones "Comprar" y "Eliminar"

```jsp
<c:forEach var='reservation' items="${reservations}">
    <tr>
        <td><c:out value="${reservation.book.title}" /></td>
        <td><c:out value="${reservation.book.author}" /></td>
        <td><c:out value="${reservation.book.price}" /> ‚Ç¨</td>
        <td><c:out value="${reservation.quantity}" /></td>
        <td>
            <c:out value="${reservation.reservationPrice}" /> ‚Ç¨
        </td>
        <td>
            <c:out value="${reservation.remainingAmount}" /> ‚Ç¨
        </td>
        <td>
            <form action="purchaseReservation" method="post">
                <input type="hidden" name="reservationId" 
                       value="${reservation.id}"/>
                <input type="submit" value="Comprar"/>
            </form>
            <form action="cancelReservationFromPage" 
                  method="post">
                <input type="hidden" name="reservationId" 
                       value="${reservation.id}"/>
                <input type="submit" value="Eliminar"/>
            </form>
        </td>
    </tr>
</c:forEach>
```

---

### 2.6 Compra de Reserva (Pago del 95%)

#### Controlador
```java
@RequestMapping("private/purchaseReservation")
public String purchaseReservation(
        @RequestParam("reservationId") int reservationId,
        Principal principal, Model model) {
    synchronized (servletContext) {
        try {
            String username = principal.getName();
            
            // El servicio valida internamente la propiedad
            reservationManagerService.purchaseReservation(
                reservationId, username);
            
            model.addAttribute("message", 
                              "reservation.purchased");
            return "redirect:myReservations";
            
        } catch (Exception e) {
            handleReservationError(e, null, model, 
                    "Error purchasing reservation", false);
            return "redirect:myReservations";
        }
    }
}
```

#### L√≥gica de Negocio
```java
@Override
public boolean purchaseReservation(int reservationId, String username) 
        throws Exception {
    // Obtener y validar propiedad
    Reservation reservation = 
        getReservationById(reservationId, username);
    
    // Procesar compra: eliminar reserva de BD
    // El stock NO se restaura porque ya se hab√≠a reducido 
    // al crear la reserva
    reservationDataService
        .deleteReservation(reservationId);
    
    logger.debug("Reservation purchased. " +
                "Stock remains reduced.");
    return true;
}
```

**Validaci√≥n de propiedad:**
```java
private Reservation getReservationById(int reservationId, String username) 
        throws Exception {
    Reservation reservation = 
        reservationDataService.getReservationById(reservationId);
    
    if (reservation == null) {
        throw new Exception("reservation.notFound");
    }
    
    if (!reservation.getUsername().equals(username)) {
        logger.warn("User {} tried to access reservation {} " +
                   "belonging to {}", username, reservationId, 
                   reservation.getUsername());
        throw new Exception("reservation.accessDenied");
    }
    
    return reservation;
}
```

---

### 2.7 Eliminaci√≥n de Reserva (Restauraci√≥n de Stock)

#### Controlador
```java
@RequestMapping("private/cancelReservationFromPage")
public String cancelReservationFromPage(
        @RequestParam("reservationId") int reservationId,
        Principal principal, Model model) {
    synchronized (servletContext) {
        try {
            String username = principal.getName();
            
            // El servicio valida internamente la propiedad
            reservationManagerService.cancelReservation(
                reservationId, username);
            
            model.addAttribute("message", 
                              "reservation.cancelled");
            return "redirect:myReservations";
            
        } catch (Exception e) {
            handleReservationError(e, null, model, 
                    "Error cancelling reservation", false);
            return "redirect:myReservations";
        }
    }
}
```

#### L√≥gica de Negocio
```java
@Override
public boolean cancelReservation(int reservationId, String username) 
        throws Exception {
    // Obtener y validar propiedad
    Reservation reservation = 
        getReservationById(reservationId, username);
    
    // Restaurar stock 
    // (IMPORTANTE: devuelve las unidades al stock)
    Book book = reservation.getBook();
    bookManagerService.increaseStock(
        book.getId(), reservation.getQuantity());
    
    // Eliminar reserva
    reservationDataService.deleteReservation(reservationId);
    
    logger.debug("Reservation cancelled and stock restored");
    return true;
}
```

**Flujo completo:**
1. Se valida que la reserva pertenece al usuario autenticado
2. Se incrementa el stock del libro en la cantidad reservada
3. Se elimina la reserva de la base de datos
4. Las unidades vuelven a estar disponibles para compra/reserva

---

### 2.8 Capa de Persistencia - ReservationDAO

```java
@Override
public Reservation createReservation(String username, 
        int bookId, int quantity) throws Exception {
    Dba dba = new Dba();
    try {
        EntityManager em = dba.getActiveEm();
        
        // Obtener el Book en el MISMO contexto 
        // de persistencia
        Book book = em.find(Book.class, bookId);
        if (book == null) {
            throw new Exception("Book not found: " 
                              + bookId);
        }
        
        // Crear la reserva
        Reservation reservation = new Reservation();
        reservation.setBook(book);
        reservation.setUsername(username);
        reservation.setQuantity(quantity);
        
        em.persist(reservation);
        return reservation;
    } finally {
        dba.closeEm();
    }
}

@Override
public List<Reservation> getReservationsByUsername(String username) 
        throws Exception {
    Dba dba = new Dba(true); // Solo lectura
    try {
        EntityManager em = dba.getActiveEm();
        
        TypedQuery<Reservation> query = em.createQuery(
            "SELECT r FROM Reservation r " + 
            "WHERE r.username = :username " +
            "ORDER BY r.id DESC", 
            Reservation.class);
        query.setParameter("username", username);
        
        List<Reservation> results = query.getResultList();
        
        // Forzar carga de libros para evitar 
        // lazy loading issues
        for (Reservation r : results) {
            r.getBook().getTitle();
        }
        
        return results;
    } finally {
        dba.closeEm();
    }
}

@Override
public Reservation updateReservation(Reservation reservation) 
        throws Exception {
    Dba dba = new Dba();
    try {
        EntityManager em = dba.getActiveEm();
        
        // Obtener la reserva gestionada por 
        // este EntityManager
        Reservation managed = em.find(Reservation.class, 
                                     reservation.getId());
        if (managed == null) {
            throw new Exception("Reservation not found");
        }
        
        // Actualizar solo el campo quantity
        managed.setQuantity(reservation.getQuantity());
        
        return managed;
    } finally {
        dba.closeEm();
    }
}

@Override
public void deleteReservation(int id) throws Exception {
    Dba dba = new Dba();
    try {
        EntityManager em = dba.getActiveEm();
        Reservation reservation = em.find(Reservation.class, id);
        if (reservation != null) {
            em.remove(reservation);
        }
    } finally {
        dba.closeEm();
    }
}
```

---

## Requisito 3: Internacionalizaci√≥n

### 3.1 Configuraci√≥n de Spring

#### Definici√≥n del LocaleResolver
En `servlet-context.xml`:

```xml
<!-- Configuraci√≥n de LocaleResolver para idiomas -->
<bean id="localeResolver" 
  class=
    "org.springframework.web.servlet.i18n.SessionLocaleResolver">
    <property name="defaultLocale" value="es" />
</bean>
```

**SessionLocaleResolver:** Almacena el idioma seleccionado en la 
sesi√≥n HTTP del usuario, manteniendo la preferencia durante toda 
la sesi√≥n.

#### Definici√≥n del MessageSource
En `beans.xml`:

```xml
<bean id="messageSource"
  class=
   "org.springframework.context.support.ResourceBundleMessageSource">
    <property name="basename" value="messages" />
    <property name="defaultEncoding" value="UTF-8" />
    <property name="fallbackToSystemLocale" value="false" />
</bean>
```

**Propiedades:**
- `basename`: Nombre base de los archivos de propiedades 
  (messages.properties, messages_en.properties)
- `defaultEncoding`: UTF-8 para soportar caracteres especiales 
  en espa√±ol
- `fallbackToSystemLocale`: false para usar siempre el idioma 
  configurado, no el del sistema

---

### 3.2 Archivos de Recursos

#### messages.properties (Espa√±ol - por defecto)
```properties
welcome=Bienvenido a <em>la m√°s peque√±a</em> tienda virtual del mundo!
login.title=Introduzca usuario y contrase√±a
book.title=T√≠tulo
cart.addToCart=A√±adir al carrito
cart.viewCart=Ver carrito
cart.shoppingCart=Carrito de compra
reservation.reserve=Reservar
reservation.myReservations=Mis Reservas
language.select=Idioma
language.spanish=Espa√±ol
language.english=Ingl√©s
# ... m√°s de 100 claves definidas
```

#### messages_en.properties (Ingl√©s)
```properties
welcome=Welcome to the <em>smallest</em> virtual shop in the world!!!
login.title=Introduce login and password
book.title=Title
cart.addToCart=Add to Cart
cart.viewCart=View Cart
cart.shoppingCart=Shopping Cart
reservation.reserve=Reserve
reservation.myReservations=My Reservations
language.select=Language
language.spanish=Spanish
language.english=English
# ... m√°s de 100 claves definidas
```

**Cobertura completa:** Se han internacionalizado todos los textos de la aplicaci√≥n:
- Formularios de login
- Cat√°logo de libros
- Carrito de compra
- Sistema de reservas
- Mensajes de error y √©xito
- Navegaci√≥n y men√∫s
- Footer y headers

---

### 3.3 Selector de Idioma

#### Componente Reutilizable (languageSelector.jsp)
```jsp
<script type="text/javascript">
function changeLanguage(lang) {
    var contextPath = '${pageContext.request.contextPath}';
    window.location.href = contextPath + '/changeLanguage?lang=' + lang;
}
</script>

<div style="text-align: right; padding: 10px; margin-bottom: 10px;">
    <label for="languageSelect">
        <spring:message code="language.select"/>: 
    </label>
    <select id="languageSelect" onchange="changeLanguage(this.value)" 
            style="padding: 5px; font-size: 14px;">
        <option value="es" 
                ${pageContext.response.locale.language == 'es' 
                  ? 'selected' : ''}>
            Espa√±ol
        </option>
        <option value="en" 
                ${pageContext.response.locale.language == 'en' 
                  ? 'selected' : ''}>
            English
        </option>
    </select>
</div>
```

**Caracter√≠sticas:**
- **Sin botones**: El cambio se realiza autom√°ticamente al seleccionar un valor 
  mediante el evento `onchange`
- **Selecci√≥n persistente**: El selector muestra el idioma actualmente activo
- **Componente reutilizable**: Se incluye en todas las p√°ginas mediante 
  `<jsp:include>`

---

### 3.4 Controlador de Cambio de Idioma

**LanguageController.java:**
```java
@Controller
public class LanguageController {
    
    @Autowired
    private LocaleResolver localeResolver;
    
    @GetMapping("/changeLanguage")
    public String changeLanguage(
            @RequestParam("lang") String lang,
            HttpServletRequest request, 
            HttpServletResponse response) {
        
        // Establecer el nuevo locale en la sesi√≥n
        Locale locale = new Locale(lang);
        localeResolver.setLocale(request, response, locale);
        
        // Redirigir a la p√°gina anterior (Referer)
        String referer = request.getHeader("Referer");
        if (referer != null && !referer.isEmpty()) {
            return "redirect:" + referer;
        }
        
        // Si no hay referer, redirigir al men√∫ principal
        return "redirect:/private/menu";
    }
}
```

**Flujo de funcionamiento:**
1. El usuario selecciona un idioma en el desplegable
2. JavaScript captura el evento `onchange` y hace una petici√≥n GET a `/changeLanguage?lang=XX`
3. El controlador establece el nuevo locale en la sesi√≥n
4. Se redirige al usuario a la misma p√°gina donde estaba (usando el header Referer)
5. La p√°gina se recarga mostrando todos los textos en el nuevo idioma

---

### 3.5 Configuraci√≥n de Seguridad

En `SecurityConfig.java` se permite el acceso sin autenticaci√≥n al endpoint de cambio de idioma:

```java
.requestMatchers("/resources/**", "/changeLanguage").permitAll()
```

Esto permite que los usuarios cambien el idioma incluso en la p√°gina de login.

---

### 3.6 Uso en las Vistas JSP

**Importaci√≥n de librer√≠as:**
```jsp
<%@ taglib uri="http://www.springframework.org/tags" prefix="spring"%>
```

**Uso de mensajes internacionalizados:**
```jsp
<!-- Texto simple -->
<h2><spring:message code="cart.shoppingCart"/></h2>

<!-- En atributos de formularios -->
<input type="submit" value="<spring:message code='cart.addToCart'/>" />

<!-- En tablas -->
<th><spring:message code="cart.title"/></th>
<th><spring:message code="cart.quantity"/></th>

<!-- Mensajes din√°micos desde el modelo -->
<spring:message code="${sessionScope.message}"/>
```

**Inclusi√≥n del selector:**
```jsp
<!-- En todas las p√°ginas -->
<jsp:include page="../languageSelector.jsp" />
```

---

## Arquitectura General

### Patr√≥n de Capas

La aplicaci√≥n sigue una arquitectura en 3 capas bien definida:

```
PRESENTACI√ìN (Controllers)
    ‚Üì
NEGOCIO (Managers/Services)
    ‚Üì
PERSISTENCIA (DAOs)
    ‚Üì
BASE DE DATOS
```

### Diagrama de Componentes

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          CAPA DE PRESENTACI√ìN                ‚îÇ
‚îÇ  CartController ‚îÇ ReservationController      ‚îÇ
‚îÇ                 ‚îÇ LanguageController         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ            ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ            CAPA DE NEGOCIO                   ‚îÇ
‚îÇ  CartManager ‚îÇ ReservationManager            ‚îÇ
‚îÇ              ‚îÇ BookManager                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ            ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         CAPA DE PERSISTENCIA                 ‚îÇ
‚îÇ  BookDAO ‚îÇ ReservationDAO ‚îÇ VATDAO           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ            ‚îÇ
             ‚ñº            ‚ñº
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ BASE DE DATOS HSQLDB ‚îÇ
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### Responsabilidades por Capa

#### Capa de Presentaci√≥n
- **Responsabilidad**: Gestionar peticiones HTTP, validaci√≥n b√°sica, 
  control de sesi√≥n
- **Componentes**: Controllers (CartController, ReservationController, 
  LanguageController)
- **No debe**: Contener l√≥gica de negocio, acceder directamente a la BD

#### Capa de Negocio
- **Responsabilidad**: L√≥gica de negocio, validaciones complejas, 
  coordinaci√≥n entre DAOs
- **Componentes**: Managers/Services (CartManager, ReservationManager, 
  BookManager)
- **No debe**: Gestionar peticiones HTTP, conocer detalles de implementaci√≥n 
  de persistencia

#### Capa de Persistencia
- **Responsabilidad**: Acceso a datos, operaciones CRUD, gesti√≥n de transacciones
- **Componentes**: DAOs (BookDAO, ReservationDAO, VATDAO)
- **No debe**: Contener l√≥gica de negocio, gestionar sesiones HTTP

---

### Inyecci√≥n de Dependencias

Todas las dependencias se gestionan mediante **Spring IoC** con configuraci√≥n XML:

```xml
<!-- beans.xml -->
<bean id="cartManagerService" 
      class="com.miw.business.cartmanager.CartManager"/>
<bean id="reservationManagerService" 
      class=
      "com.miw.business.reservationmanager.ReservationManager"/>
<bean id="bookDataService" 
      class="com.miw.persistence.book.BookDAO"/>
<bean id="reservationDataService" 
      class=
      "com.miw.persistence.reservation.ReservationDAO"/>
```

**Inyecci√≥n en Controladores:**
```java
@Controller
public class CartController {
    @Autowired
    private CartManagerService cartManagerService;
}
```

**Inyecci√≥n en Managers:**
```java
public class CartManager implements CartManagerService {
    @Autowired
    private BookManagerService bookManagerService;
    
    @Autowired
    private ReservationManagerService reservationManagerService;
}
```

---

## Conclusiones

### Funcionalidades Implementadas

‚úÖ **Requisito 1: Compra de Libros**
- Control de stock en base de datos
- Carrito de compra funcional
- Validaci√≥n de disponibilidad en tiempo real
- Actualizaci√≥n de stock tras checkout
- Al menos 3 libros con 10 unidades iniciales cada uno

‚úÖ **Requisito 2: Sistema de Reservas**
- Funcionalidad de reservar libros
- Marca especial en carrito (5% pagado, 95% pendiente)
- Reducci√≥n de stock inmediata al reservar
- Secci√≥n "Mis Reservas" con opciones Comprar/Eliminar
- Pago del 95% restante al comprar
- Restauraci√≥n de stock al eliminar reserva

‚úÖ **Requisito 3: Internacionalizaci√≥n**
- Soporte completo para espa√±ol (es) e ingl√©s (en)
- Selector de idioma en todas las p√°ginas
- Cambio autom√°tico sin botones (evento onchange)
- M√°s de 100 claves de traducci√≥n
- Persistencia del idioma en sesi√≥n

### Aspectos T√©cnicos Destacables

- **Bloqueos pesimistas** en operaciones de stock para garantizar 
  consistencia
- **Sincronizaci√≥n con BD** en cada acceso al carrito
- **Rollback autom√°tico** si falla la creaci√≥n de reservas
- **Validaci√≥n de propiedad** en operaciones de reservas
- **Mensajes internacionalizados** incluso en excepciones
- **Protecci√≥n CSRF** en todos los formularios

---

**Documento generado el:** 27 de octubre de 2025  
**Autor:** Implementaci√≥n del Trabajo 2 - MIW  
**Versi√≥n:** 1.1  
**URL de Despliegue:** http://156.35.95.57:8080/Amazin_Spring_19_0/

